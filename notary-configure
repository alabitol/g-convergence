#!/bin/bash
# Default locations for private key and self-signed certificate

KEYFILE="./convergence.key"
CERTFILE="./convergence.pem"

# Check if openssl is installed, and figure out the absolute path of openssl
OPENSSL=$(command -v openssl)
if [ -z "$OPENSSL" ]; then
    echo "Openssl is not installed. Please install openssl before running the notary."
    exit
fi

# Prompt user for private key name
echo "Insert desired private key name (defaults to ./convergence.key): "
read PROMPT
if [ -n "$PROMPT" ]; then
    KEYFILE=$PROMPT
fi

# If $KEYFILE already exists, ask if the user wishes to overwrite
if [ -e $KEYFILE ]; then
    echo "Warning: You are about to overwrite $KEYFILE. Do you wish to proceed?"
    read -n 1 PREF
    if [ $PREF != "y" ] || [ -z $PREF ]; then
       exit
    fi
fi

# Generate private key
$OPENSSL genrsa -out $KEYFILE 2048
echo "

"
# Prompt user for certificate name
echo "Insert desired certificate name (defaults to ./convergence.pem): "
read PROMPT
if [ -n "$PROMPT" ]; then
    CERTFILE=$PROMPT
fi

# If the CERTFILE already exists, prompt user before overwriting
if [ -e $CERTFILE ]; then
    echo "Warning: You are about to overwrite $CERTFILE. Do you wish to \
proceed?"
    read -n 1 PREF
    if ( $PREF != "y" ) ; then
        if [ -z $PREF ] ; then
            exit
        fi
    fi
fi

# If intermediate file mycert.csr exists, prompt user before overwriting
if [ -e "./mycert.csr" ]; then
    echo "Warning: About to delete intermediate file mycert.csr. Do you wish to overwrite?"
    read -n 1 PREF
    if [ $PREF != "y" || -z $PREF ]; then
       exit
    fi
fi

# Create certificate request file
$OPENSSL req -new -key $KEYFILE -out ./mycert.csr

# Sign our certificate request to make a real certificate
$OPENSSL x509 -req -days 365 -in mycert.csr -signkey $KEYFILE -out $CERTFILE

# Confirm successful key/certificate generation
echo "Successful generation of key in $KEYFILE and certificate in $CERTFILE. Certificate valid for one year from present date."
# Delete intermediate files
rm mycert.csr
